# Story 1.1 — Manual Price Update from Assets List (POST /prices)

Status: Draft
Assignee: Dev Agent
Links: PRD docs/assets/PRD-AssetPriceUpdate.md

## Story Statement
As a user, I want to update the latest price of an asset directly from the Assets list so that my portfolio reflects the most recent value when an automated source is unavailable or inaccurate.

## Acceptance Criteria
1. FE action “Update Price” is available on each asset row and opens a modal with fields: price (required, numeric), timestamp (optional, defaults to now). `assetId` is implied from the row.
2. FE submits `POST /prices` with payload: `assetId`, `price`, optional `timestamp`, optional `source` (set to `MANUAL` by default on FE), optional `market`, and `isManual=true`.
3. BE persists price. If new price timestamp is >= current latest, the previous latest is flipped to `isLatest=false` and new record has `isLatest=true`. If older, `isLatest=false` is set on the new record. Response includes `isManual` and `isLatest`.
4. `/assets/summary` reflects the manual price once it is latest (after FE refresh or cache expiry).
5. Input validation: price > 0, `assetId` is a valid UUID, timestamp parseable when provided. Auth required.

## Out of Scope
- Role-based restrictions beyond existing auth.
- Real-time cache invalidation.

## Dev Notes
- Previous Story Insights: No previous story.
- Data Models:
  - `be/src/prices/entities/price.entity.ts` includes `isManual: boolean` (default false) and `isLatest: boolean` (default false). Currency defaults handled in service.
  - Decimal fields are strings in entity/DTO. Timestamp is Date.
  [Source: be/docs/project-architecture.md#Source Tree and Module Organization]
- API Specifications:
  - `POST /prices` implemented in `PricesController.create` with `CreatePriceDto`.
  - `CreatePriceDto` currently requires: `assetId` (UUID), `price` (number string), `timestamp` (required today but service can default), `source` (string), `market` (string), optional `currency`, and optional `isManual` (defaults true in service). We plan to make `timestamp` optional for FE ease.
  - `PricesService.create` computes latest semantics and persists `isManual` and `isLatest` accordingly; defaults timestamp to now and currency to asset baseCurrency when omitted; sets `isManual` to dto value or true.
  [Source: be/src/prices/prices.service.ts]
- Component Specifications:
  - Assets list page: `fe/src/pages/AssetsPage.tsx` renders action dropdown per row; we will add “Update Price” item and a modal component.
  - Modal: fields `price` (number with 4dp), `timestamp` (datetime-local), optional `market`, hidden `assetId`, and implicit `source=MANUAL`. Submit via axios client at `fe/src/lib/api/client.ts` to `POST /prices`.
  - Toast on success; refresh summary via existing `getAssetsSummary()` or force re-fetch.
- File Locations:
  - FE modal: `fe/src/components/assets/UpdatePriceModal.tsx`
  - FE integration: update `fe/src/pages/AssetsPage.tsx` dropdown to include action and handle modal state
  - FE service helper: extend `fe/src/services/assetService.ts` with `createManualPrice(assetId, price, timestamp?, market?)`
  - BE: Entity already has `isManual`; DTO allows `isManual` optional and service defaults to true; no schema change needed.
- Testing Requirements:
  - Backend unit test for `PricesService.create` latest flipping when equal/newer timestamp and retention when older.
  - Controller e2e test for `POST /prices` returning 201 and correct flags.
  - Frontend component test for modal validation and submission payload.
- Technical Constraints:
  - Use Swagger decorators for any DTO changes (none required now).
  - Keep TypeORM `synchronize: true` assumption for local dev.

## Tasks / Subtasks

### Backend
1. Verify `Price` entity exposes `isManual` and `isLatest` in Swagger schema. [be/src/prices/entities/price.entity.ts]
2. Make `CreatePriceDto.timestamp` optional since service defaults. Update Swagger accordingly. [be/src/prices/dto/create-price.dto.ts]
3. Add validation: `price > 0` in DTO using regex or custom validator (decimal > 0). [class-validator]
4. Add Swagger examples for manual creation with `source=MANUAL`. [@nestjs/swagger]
5. Tests:
   - Unit: `PricesService` create latest logic.
   - e2e: POST /prices 201 with `isManual=true` and `isLatest` per timestamp.

### Frontend
6. Create `fe/src/components/assets/UpdatePriceModal.tsx` with fields: price (required, numeric with up to 4 decimals), timestamp (optional, default now), optional market.
7. Add “Update Price” action to each asset row dropdown in `fe/src/pages/AssetsPage.tsx` which opens the modal with the row `assetId`.
8. Implement service call in `fe/src/services/assetService.ts`:
   - `createManualPrice({ assetId, price, timestamp, market, source='MANUAL', isManual: true })` → POST `/prices`.
9. On success: show toast and refresh list via existing `getAssetsSummary()`; optionally force reload.
10. i18n: Add keys to `fe/src/locales/en.json` and `vi.json` for labels and toasts.
11. Tests: component-level validation test for modal.

## Project Structure Notes
- Aligns with documented backend and frontend structure. No new patterns introduced.

## Implementation
- Task document: docs/assets/PRD-AssetPriceUpdate.md
- Technical Design Document: be/docs/project-architecture.md


